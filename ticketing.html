<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complaints — Orleans Parish Community</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primary: #00235c;
      --primary-light: #80aaed;
      --primary-dark: #001845;
      --accent: #80aaed;
      --bg: #F4F6F9;
      --bg-card: #FFFFFF;
      --text: #1A1A1A;
      --text-muted: #5A6577;
      --text-light: #8D95A3;
      --border: #D8DEE8;
      --border-focus: #00235c;
      --error: #C4392D;
      --error-bg: #FDF2F1;
      --success: #2E7D32;
      --success-bg: #E8F5E9;
      --warning: #E65100;
      --warning-bg: #FFF3E0;
      --info-bg: #EDF2FC;
      --radius: 12px;
      --radius-sm: 8px;
      --radius-xs: 6px;
      --shadow: 0 1px 3px rgba(0, 35, 92, 0.06), 0 4px 12px rgba(0, 35, 92, 0.04);
      --shadow-lg: 0 4px 24px rgba(0, 35, 92, 0.10);
    }

    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
    }

    body {
      font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
    }

    .app-shell {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ─── Top Bar ─────────────────────────────────────────── */
    .top-bar {
      background: var(--primary);
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 100;
      flex-shrink: 0;
    }

    .top-bar .nav-logo {
      height: 40px;
      width: 40px;
      border-radius: 50%;
      object-fit: contain;
      flex-shrink: 0;
    }

    .top-bar .brand {
      font-family: 'DM Serif Display', serif;
      color: #fff;
      font-size: 1.05rem;
      letter-spacing: 0.02em;
    }

    .nav-spacer {
      flex: 1;
    }

    .nav-links {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .nav-link {
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 7px 14px;
      border-radius: var(--radius-xs);
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      background: none;
      font-family: inherit;
    }

    .nav-link:hover {
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
    }

    .nav-link.active {
      color: #fff;
      background: rgba(255, 255, 255, 0.18);
    }

    /* ─── Main Layout ─────────────────────────────────────── */
    .main-layout {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
    }

    .map-container {
      flex: 1;
      position: relative;
      min-width: 0;
    }

    .map-container #ticketMap {
      width: 100%;
      height: 100%;
    }

    /* ─── Resize Handle ───────────────────────────────────── */
    .resize-handle {
      width: 6px;
      cursor: col-resize;
      background: var(--border);
      flex-shrink: 0;
      position: relative;
      z-index: 10;
      transition: background 0.15s;
    }

    .resize-handle:hover,
    .resize-handle.dragging {
      background: var(--primary-light);
    }

    .resize-handle::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 2px;
      height: 32px;
      border-radius: 2px;
      background: var(--text-light);
      opacity: 0.5;
      transition: opacity 0.15s;
    }

    .resize-handle:hover::after,
    .resize-handle.dragging::after {
      opacity: 1;
      background: var(--primary);
    }

    /* ─── Side Panel ──────────────────────────────────────── */
    .side-panel {
      width: 50%;
      flex-shrink: 0;
      background: var(--bg-card);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .panel-header h2 {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--primary-dark);
      flex: 1;
    }

    .panel-header .ticket-count {
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text-muted);
      background: var(--bg);
      padding: 3px 10px;
      border-radius: 20px;
    }

    .btn-new-ticket {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--radius-xs);
      font-family: inherit;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-new-ticket:hover {
      background: var(--primary-light);
      transform: translateY(-1px);
    }

    /* ─── Filter Bar ──────────────────────────────────────── */
    .filter-bar {
      padding: 10px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      flex-shrink: 0;
      background: var(--bg);
    }

    .filter-select {
      padding: 6px 10px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-xs);
      font-family: inherit;
      font-size: 0.76rem;
      font-weight: 600;
      color: var(--text-muted);
      background: var(--bg-card);
      cursor: pointer;
      outline: none;
      transition: border-color 0.2s;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%235A6577' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      padding-right: 24px;
    }

    .filter-select:focus {
      border-color: var(--border-focus);
    }

    .filter-select.active-filter {
      border-color: var(--primary);
      color: var(--primary);
      background-color: var(--info-bg);
    }

    .filter-clear {
      padding: 6px 10px;
      border: none;
      border-radius: var(--radius-xs);
      font-family: inherit;
      font-size: 0.74rem;
      font-weight: 600;
      color: var(--error);
      background: var(--error-bg);
      cursor: pointer;
      transition: all 0.15s;
      display: none;
    }

    .filter-clear.visible {
      display: inline-block;
    }

    .filter-clear:hover {
      background: #f5d5d2;
    }

    /* ─── Ticket List ─────────────────────────────────────── */
    .ticket-list {
      flex: 1;
      overflow-y: auto;
    }

    .ticket-item {
      padding: 14px 20px;
      border-bottom: 1px solid rgba(216, 222, 232, 0.5);
      cursor: pointer;
      transition: background 0.15s;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .ticket-item:hover {
      background: var(--bg);
    }

    .ticket-item.active {
      background: var(--info-bg);
      border-left: 3px solid var(--primary);
    }

    .ticket-item .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-top: 5px;
      flex-shrink: 0;
    }

    .status-dot.open {
      background: var(--warning);
    }

    .status-dot.in-progress {
      background: var(--primary-light);
    }

    .status-dot.resolved {
      background: var(--success);
    }

    .status-dot.closed {
      background: #546E7A;
    }

    .status-dot.escalated {
      background: #C62828;
    }

    .ticket-item .ticket-info {
      flex: 1;
      min-width: 0;
    }

    .ticket-item .ticket-case {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: 0.03em;
    }

    .ticket-item .ticket-addr {
      font-size: 0.88rem;
      font-weight: 600;
      color: var(--text);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ticket-item .ticket-preview {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ticket-item .ticket-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    .ticket-item .ticket-date {
      font-size: 0.72rem;
      color: var(--text-light);
    }

    .ticket-item .ticket-status-badge {
      font-size: 0.68rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 10px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .ticket-status-badge.open {
      background: var(--warning-bg);
      color: var(--warning);
    }

    .ticket-status-badge.in-progress {
      background: var(--info-bg);
      color: var(--primary);
    }

    .ticket-status-badge.resolved {
      background: var(--success-bg);
      color: var(--success);
    }

    .ticket-status-badge.closed {
      background: #ECEFF1;
      color: #546E7A;
    }

    .ticket-status-badge.escalated {
      background: #FCE4EC;
      color: #C62828;
    }

    .urgency-badge {
      font-size: 0.68rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 10px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .urgency-badge.high {
      background: #FDE8E8;
      color: #C4392D;
    }

    .urgency-badge.medium {
      background: var(--warning-bg);
      color: var(--warning);
    }

    .urgency-badge.low {
      background: #E8F5E9;
      color: #2E7D32;
    }

    /* ─── Chat / Detail View ──────────────────────────────── */
    .chat-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .chat-header-top {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chat-back-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      transition: color 0.15s;
    }

    .chat-back-btn:hover {
      color: var(--primary);
    }

    .chat-header-info {
      flex: 1;
    }

    .chat-header-case {
      font-size: 0.72rem;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .chat-header-addr {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--primary-dark);
      margin-top: 1px;
    }

    .chat-header-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
    }

    .chat-meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .chat-meta-item svg {
      width: 13px;
      height: 13px;
      opacity: 0.6;
    }

    .assigned-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 10px;
      background: var(--info-bg);
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--primary);
    }

    .assigned-avatar {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      font-size: 0.6rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ─── Case Actions ────────────────────────────────────── */
    .case-actions {
      display: flex;
      gap: 8px;
      padding: 10px 20px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      background: var(--bg);
    }

    .case-action-btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 7px 14px;
      border-radius: var(--radius-xs);
      font-family: inherit;
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: 1.5px solid var(--border);
      background: var(--bg-card);
      color: var(--text-muted);
    }

    .case-action-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .case-action-btn svg {
      width: 14px;
      height: 14px;
    }

    .case-action-btn.close-case {
      border-color: var(--success);
      color: var(--success);
    }

    .case-action-btn.close-case:hover {
      background: var(--success-bg);
    }

    .case-action-btn.escalate-case {
      border-color: var(--warning);
      color: var(--warning);
    }

    .case-action-btn.escalate-case:hover {
      background: var(--warning-bg);
    }

    .case-action-btn.closed-badge {
      border-color: var(--success);
      background: var(--success-bg);
      color: var(--success);
      cursor: default;
    }

    .case-action-btn.closed-badge:hover {
      transform: none;
      box-shadow: none;
    }

    /* ─── Chat Messages ───────────────────────────────────── */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .msg {
      display: flex;
      gap: 10px;
      max-width: 92%;
      animation: msgIn 0.3s ease-out both;
    }

    .msg.customer {
      align-self: flex-start;
    }

    .msg.system {
      align-self: center;
      max-width: 88%;
    }

    .msg.contractor {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .msg-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      color: #fff;
    }

    .msg.customer .msg-avatar {
      background: #5C6BC0;
    }

    .msg.contractor .msg-avatar {
      background: #43A047;
    }

    .msg-body {
      flex: 1;
      min-width: 0;
    }

    .msg-sender {
      font-size: 0.72rem;
      font-weight: 700;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .msg.customer .msg-sender {
      color: #5C6BC0;
    }

    .msg.contractor .msg-sender {
      color: #43A047;
      justify-content: flex-end;
    }

    .msg-time {
      font-size: 0.68rem;
      font-weight: 500;
      color: var(--text-light);
    }

    .msg-bubble {
      padding: 12px 16px;
      border-radius: 14px;
      font-size: 0.88rem;
      line-height: 1.55;
    }

    .msg.customer .msg-bubble {
      background: #F0F2F5;
      color: var(--text);
      border-top-left-radius: 4px;
    }

    .msg.contractor .msg-bubble {
      background: #E8F5E9;
      color: var(--text);
      border-top-right-radius: 4px;
    }

    .msg-photo {
      display: block;
      width: 140px;
      height: auto;
      border-radius: 8px;
      margin-top: 8px;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .msg-photo:hover {
      transform: scale(1.02);
    }

    /* System / AI Messages */
    .system-card {
      width: 100%;
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }

    .system-card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      font-size: 0.78rem;
      font-weight: 700;
    }

    .system-card-header svg {
      width: 16px;
      height: 16px;
    }

    .system-card-header.ai {
      background: linear-gradient(135deg, #EDE7F6, #E8EAF6);
      color: #512DA8;
    }

    .ai-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.62rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      background: linear-gradient(135deg, #7C4DFF, #536DFE);
      color: #fff;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .ai-tag svg {
      width: 10px;
      height: 10px;
    }

    .ai-tag-body {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 9px;
      border-radius: 4px;
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      background: linear-gradient(135deg, #EDE7F6, #E8EAF6);
      color: #512DA8;
      margin-bottom: 8px;
    }

    .ai-tag-body svg {
      width: 12px;
      height: 12px;
    }

    .system-card-header.info {
      background: var(--info-bg);
      color: var(--primary);
    }

    .system-card-header.forwarded {
      background: #FFF3E0;
      color: #E65100;
    }

    .system-card-header.connected {
      background: var(--success-bg);
      color: var(--success);
    }

    .system-card-body {
      padding: 12px 14px;
      font-size: 0.85rem;
      line-height: 1.6;
      color: var(--text);
      background: var(--bg-card);
    }

    .ai-summary {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .ai-summary-thumb {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-xs);
      object-fit: cover;
      flex-shrink: 0;
      border: 1px solid var(--border);
    }

    .system-card-body .forwarded-photo {
      display: block;
      width: 120px;
      height: auto;
      max-height: 90px;
      object-fit: cover;
      border-radius: var(--radius-xs);
      border: 1px solid var(--border);
      margin-bottom: 10px;
    }

    .ai-summary-text {
      flex: 1;
    }

    .ai-summary-text strong {
      display: block;
      font-size: 0.78rem;
      color: #512DA8;
      margin-bottom: 3px;
    }

    /* ─── Chat Input ──────────────────────────────────────── */
    .chat-input-bar {
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
      align-items: flex-end;
      flex-shrink: 0;
      background: var(--bg-card);
    }

    .chat-input-bar textarea {
      flex: 1;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      font-family: inherit;
      font-size: 0.88rem;
      color: var(--text);
      resize: none;
      outline: none;
      min-height: 42px;
      max-height: 100px;
      transition: border-color 0.2s;
    }

    .chat-input-bar textarea:focus {
      border-color: var(--border-focus);
    }

    .chat-send-btn {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .chat-send-btn:hover {
      background: var(--primary-light);
      transform: scale(1.05);
    }

    /* ─── New Ticket Form ─────────────────────────────────── */
    .form-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .form-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .form-title {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--primary-dark);
      margin-bottom: 20px;
    }

    .form-field {
      margin-bottom: 16px;
    }

    .form-field label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
    }

    .form-field input,
    .form-field textarea {
      width: 100%;
      padding: 11px 14px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 0.9rem;
      color: var(--text);
      background: #fff;
      transition: border-color 0.2s, box-shadow 0.2s;
      outline: none;
    }

    .form-field input:focus,
    .form-field textarea:focus {
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(0, 35, 92, 0.1);
    }

    .form-field textarea {
      resize: vertical;
      min-height: 90px;
    }

    .form-field .datetime-display {
      padding: 11px 14px;
      background: var(--bg);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-field .datetime-display svg {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
    }

    .photo-upload-area {
      border: 2px dashed var(--border);
      border-radius: var(--radius-sm);
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--bg);
    }

    .photo-upload-area:hover {
      border-color: var(--primary-light);
      background: var(--info-bg);
    }

    .photo-upload-area svg {
      width: 28px;
      height: 28px;
      color: var(--text-light);
      margin-bottom: 6px;
    }

    .photo-upload-area p {
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .photo-upload-area .hint {
      font-size: 0.72rem;
      color: var(--text-light);
      margin-top: 2px;
    }

    .photo-preview {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .photo-preview img {
      width: 64px;
      height: 64px;
      border-radius: var(--radius-xs);
      object-fit: cover;
      border: 1px solid var(--border);
    }

    .form-actions {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      flex-shrink: 0;
    }

    .btn-submit {
      flex: 1;
      padding: 12px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-submit:hover {
      background: var(--primary-light);
    }

    .btn-cancel {
      padding: 12px 20px;
      background: transparent;
      color: var(--text-muted);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-cancel:hover {
      border-color: var(--text-muted);
      color: var(--text);
    }

    /* ─── Autocomplete ────────────────────────────────────── */
    .autocomplete-wrap {
      position: relative;
    }

    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1.5px solid var(--border);
      border-top: none;
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      box-shadow: var(--shadow-lg);
      z-index: 50;
      max-height: 180px;
      overflow-y: auto;
    }

    .autocomplete-item {
      padding: 10px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      color: var(--text);
      transition: background 0.15s;
    }

    .autocomplete-item:hover {
      background: var(--info-bg);
    }

    /* ─── Map Markers ─────────────────────────────────────── */
    .ticket-marker {
      background: var(--primary);
      color: #fff;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      border: 2.5px solid #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .ticket-marker.selected {
      background: var(--error);
      transform: scale(1.2);
    }

    .marker-popup {
      font-family: 'Plus Jakarta Sans', sans-serif;
    }

    .marker-popup strong {
      color: var(--primary);
      font-size: 0.85rem;
    }

    .marker-popup .popup-addr {
      font-size: 0.82rem;
      color: var(--text);
      margin-top: 2px;
    }

    .marker-popup .popup-status {
      font-size: 0.72rem;
      font-weight: 600;
      margin-top: 4px;
    }

    /* ─── Animations ──────────────────────────────────────── */
    @keyframes msgIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(12px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ─── Scrollbar ───────────────────────────────────────── */
    .ticket-list::-webkit-scrollbar,
    .chat-messages::-webkit-scrollbar,
    .form-scroll::-webkit-scrollbar {
      width: 5px;
    }

    .ticket-list::-webkit-scrollbar-track,
    .chat-messages::-webkit-scrollbar-track,
    .form-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .ticket-list::-webkit-scrollbar-thumb,
    .chat-messages::-webkit-scrollbar-thumb,
    .form-scroll::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 10px;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    /* ═══════════════════════════════════════════════════════════
       SUPABASE CONFIG (same as main app — public read-only)
       ═══════════════════════════════════════════════════════════ */
    const SUPABASE_URL = 'https://clcufcjifbvpbtsczkmx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsY3VmY2ppZmJ2cGJ0c2N6a214Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzMTg0MjUsImV4cCI6MjA2Njg5NDQyNX0.peSxA-RStQrPYFdWyewjg_9wA-YQ73ZU4IRXoknTfUA';
    const SUPABASE_HEADERS = {
      'apikey': SUPABASE_ANON_KEY,
      'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
    };


    /* ═══════════════════════════════════════════════════════════
       MOCK TICKET DATA
       ═══════════════════════════════════════════════════════════ */
    const MOCK_TICKETS = [
      {
        id: 'CMP-2026-0041',
        address: '6269 COLBERT ST',
        customer: 'Stuart Seiler',
        message: 'The investigator dug up my frontyard during the lead pipe inspection, but it was never filled back to its original form. There are visible holes in the grass and the yard is uneven. I would appreciate it if this could be fixed as soon as possible.',
        photo: 'photos/IMG_7549.jpg',
        date: '2026-02-26T11:00:00',
        status: 'in-progress',
        urgency: 'high',
        lat: 29.9335,
        lng: -90.0308,
        assignedTo: 'Mike Reynolds',
        assignedRole: 'Field Contractor',
        messages: [
          {
            type: 'customer',
            sender: 'Stuart Seiler',
            text: 'The investigator dug up my frontyard during the lead pipe inspection, but it was never filled back to its original form. There are visible holes in the grass and the yard is uneven. I would appreciate it if this could be fixed as soon as possible.',
            photo: 'photos/IMG_7549.jpg',
            time: '11:00 AM',
          },
          {
            type: 'system',
            variant: 'info',
            title: 'Complaint Received',
            icon: 'check',
            text: 'We have received your complaint and our AI has analyzed the uploaded photo. We will work to resolve this issue promptly.',
            aiGenerated: true,
            time: '11:01 AM',
          },
          {
            type: 'system',
            variant: 'ai',
            title: 'AI Photo Analysis',
            icon: 'ai',
            text: 'The uploaded image shows a residential frontyard where ground has been excavated and not properly restored. There are two visible holes in the grass area near what appears to be a utility access point. The surrounding lawn shows signs of heavy equipment use with soil displacement and uneven terrain.',
            photo: 'photos/IMG_7549.jpg',
            time: '11:01 AM',
          },
          {
            type: 'system',
            variant: 'forwarded',
            title: 'Forwarded to Contractor — Mike Reynolds',
            icon: 'forward',
            text: 'Hi Mike, a complaint has been filed by Stuart Seiler at 6269 Colbert St regarding incomplete restoration after a lead pipe inspection. The customer reports that the frontyard was excavated but never restored to its original condition, leaving visible holes and uneven terrain. Please review the attached photo and AI analysis below and schedule a site visit to restore the yard. This is marked as high urgency.',
            photo: 'photos/IMG_7549.jpg',
            aiSummary: 'The image shows a residential frontyard with two visible excavation holes in the grass near a utility access point. The surrounding lawn has soil displacement and uneven ground consistent with heavy equipment use. Restoration work — including backfill, grading, and re-sodding — is required.',
            time: '11:03 AM',
          },
          {
            type: 'system',
            variant: 'connected',
            title: 'Contractor Connected',
            icon: 'connected',
            text: 'Mike Reynolds (Field Contractor) has joined the conversation.',
            time: '11:05 AM',
          },
          {
            type: 'contractor',
            sender: 'Mike Reynolds',
            text: "Hello Stuart, I'm extremely sorry about the condition of your frontyard. I've reviewed the photos and the AI analysis. I can come back today to fill the holes and restore the yard to its original condition. How does 2:00 PM work for you?",
            time: '11:08 AM',
          },
        ],
      },
      {
        id: 'CMP-2026-0039',
        address: '3841 ULLOA ST',
        customer: 'Maria Gonzalez',
        message: 'Water meter cover is broken and sticking up from the sidewalk. It is a tripping hazard for pedestrians.',
        photo: null,
        date: '2026-02-25T09:30:00',
        status: 'open',
        urgency: 'medium',
        lat: 29.9680,
        lng: -90.1020,
        assignedTo: null,
        assignedRole: null,
        messages: [
          {
            type: 'customer',
            sender: 'Maria Gonzalez',
            text: 'Water meter cover is broken and sticking up from the sidewalk. It is a tripping hazard for pedestrians. This has been an issue for over two weeks now.',
            time: '9:30 AM',
          },
          {
            type: 'system',
            variant: 'info',
            title: 'Complaint Received',
            icon: 'check',
            text: 'We have received your complaint. A team member will review and assign a contractor shortly.',
            time: '9:31 AM',
          },
        ],
      },
      {
        id: 'CMP-2026-0035',
        address: '1525 GENERAL TAYLOR ST',
        customer: 'James Whitfield',
        message: 'Lead pipe replacement crew left debris and construction materials on the street in front of my house. The sidewalk is partially blocked.',
        photo: null,
        date: '2026-02-24T14:15:00',
        status: 'resolved',
        urgency: 'high',
        lat: 29.9260,
        lng: -90.0820,
        assignedTo: 'Carlos Martinez',
        assignedRole: 'Cleanup Crew Lead',
        messages: [
          {
            type: 'customer',
            sender: 'James Whitfield',
            text: 'Lead pipe replacement crew left debris and construction materials on the street in front of my house. The sidewalk is partially blocked and it\'s been 3 days.',
            time: '2:15 PM',
          },
          {
            type: 'system',
            variant: 'info',
            title: 'Complaint Received',
            icon: 'check',
            text: 'We have received your complaint and will address it immediately.',
            time: '2:16 PM',
          },
          {
            type: 'system',
            variant: 'forwarded',
            title: 'Forwarded to Contractor — Carlos Martinez',
            icon: 'forward',
            text: 'Hi Carlos, a complaint has been filed by James Whitfield at 1525 General Taylor St. The customer reports that a lead pipe replacement crew left debris and construction materials on the street, partially blocking the sidewalk. This has persisted for 3 days. Please dispatch your cleanup crew to clear all materials and restore full pedestrian access. Marked as high urgency.',
            aiSummary: 'Based on the complaint description, construction debris including pipe segments, soil, and equipment remains are obstructing the sidewalk and street frontage at the reported address. A full cleanup with sidewalk clearance is needed.',
            time: '2:20 PM',
          },
          {
            type: 'system',
            variant: 'connected',
            title: 'Contractor Connected',
            icon: 'connected',
            text: 'Carlos Martinez (Cleanup Crew Lead) has joined the conversation.',
            time: '2:22 PM',
          },
          {
            type: 'contractor',
            sender: 'Carlos Martinez',
            text: 'Hi James, I sincerely apologize for the inconvenience. My crew will be there within the hour to clear everything. We\'ll make sure the sidewalk and street are completely clean.',
            time: '2:25 PM',
          },
          {
            type: 'customer',
            sender: 'James Whitfield',
            text: 'Thank you! The crew came and cleaned everything up. Looks great now.',
            time: '4:10 PM',
          },
          {
            type: 'system',
            variant: 'connected',
            title: 'Ticket Resolved',
            icon: 'check',
            text: 'This complaint has been marked as resolved.',
            time: '4:15 PM',
          },
        ],
      },
      {
        id: 'CMP-2026-0037',
        address: '2215 N GALVEZ ST',
        customer: 'Patricia Adams',
        message: 'After the water line work, my water pressure has been significantly lower than before. Please send someone to check.',
        photo: null,
        date: '2026-02-25T08:00:00',
        status: 'in-progress',
        urgency: 'medium',
        lat: 29.9710,
        lng: -90.0640,
        assignedTo: 'Tom Henderson',
        assignedRole: 'Plumbing Specialist',
        messages: [
          {
            type: 'customer',
            sender: 'Patricia Adams',
            text: 'After the water line work last week, my water pressure has been significantly lower than before. Please send someone to check. It is affecting all faucets in the house.',
            time: '8:00 AM',
          },
          {
            type: 'system',
            variant: 'info',
            title: 'Complaint Received',
            icon: 'check',
            text: 'We have received your complaint and are looking into it.',
            time: '8:02 AM',
          },
          {
            type: 'system',
            variant: 'forwarded',
            title: 'Forwarded to Specialist — Tom Henderson',
            icon: 'forward',
            text: 'Hi Tom, a complaint has been filed by Patricia Adams at 2215 N Galvez St regarding reduced water pressure following recent water line work. The customer reports that all faucets in the house are affected and the issue began immediately after the service work was completed. Please inspect the line for any partially closed valves or connection issues.',
            aiSummary: 'Post-service pressure drop across all fixtures suggests a main shut-off valve may not have been fully reopened, or there may be a restriction at the new service connection point. On-site pressure test recommended.',
            time: '8:15 AM',
          },
          {
            type: 'system',
            variant: 'connected',
            title: 'Specialist Connected',
            icon: 'connected',
            text: 'Tom Henderson (Plumbing Specialist) has joined the conversation.',
            time: '8:20 AM',
          },
          {
            type: 'contractor',
            sender: 'Tom Henderson',
            text: 'Good morning Patricia. Low pressure after line work can sometimes indicate a partially closed valve. I\'ll be out tomorrow morning around 9 AM to inspect. I should have it fixed quickly.',
            time: '8:25 AM',
          },
        ],
      },
      {
        id: 'CMP-2026-0033',
        address: '4417 DOWNMAN RD',
        customer: 'Robert Chen',
        message: 'The restoration work on my driveway after the pipe replacement is cracking already. The concrete they used seems to be low quality.',
        photo: null,
        date: '2026-02-23T16:45:00',
        status: 'open',
        urgency: 'low',
        lat: 30.0050,
        lng: -90.0200,
        assignedTo: null,
        assignedRole: null,
        messages: [
          {
            type: 'customer',
            sender: 'Robert Chen',
            text: 'The restoration work on my driveway after the pipe replacement is cracking already. It has only been a month. The concrete they used seems to be low quality. This needs to be redone properly.',
            time: '4:45 PM',
          },
          {
            type: 'system',
            variant: 'info',
            title: 'Complaint Received',
            icon: 'check',
            text: 'We have received your complaint. A supervisor will review and schedule an inspection.',
            time: '4:46 PM',
          },
        ],
      },
    ];


    /* ═══════════════════════════════════════════════════════════
       ICONS
       ═══════════════════════════════════════════════════════════ */
    const IconPlus = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"><path d="M12 5v14M5 12h14" /></svg>;
    const IconBack = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 12H5M12 19l-7-7 7-7" /></svg>;
    const IconSend = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4z" /></svg>;
    const IconCamera = () => <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z" /><circle cx="12" cy="13" r="4" /></svg>;
    const IconClock = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><circle cx="12" cy="12" r="10" /><path d="M12 6v6l4 2" /></svg>;
    const IconUser = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2" /><circle cx="12" cy="7" r="4" /></svg>;
    const IconCheck = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"><path d="M20 6L9 17l-5-5" /></svg>;
    const IconAI = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M12 2a4 4 0 014 4v1h2a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V9a2 2 0 012-2h2V6a4 4 0 014-4z" /><circle cx="9" cy="13" r="1" /><circle cx="15" cy="13" r="1" /><path d="M10 17h4" /></svg>;
    const IconForward = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>;
    const IconConnect = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M8 12h8M12 8v8" /><circle cx="12" cy="12" r="10" /></svg>;
    const IconPin = () => <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z" /><circle cx="12" cy="10" r="3" /></svg>;
    const IconClose = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"><path d="M20 6L9 17l-5-5" /></svg>;
    const IconEscalate = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 19V5M5 12l7-7 7 7" /></svg>;
    const IconFilter = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z" /></svg>;


    /* ═══════════════════════════════════════════════════════════
       ADDRESS INPUT (with Supabase autocomplete)
       ═══════════════════════════════════════════════════════════ */
    function TicketAddressInput({ value, onChange }) {
      const [suggestions, setSuggestions] = useState([]);
      const [showDropdown, setShowDropdown] = useState(false);
      const debounceRef = useRef(null);

      const fetchSuggestions = async (text) => {
        if (text.length < 3) { setSuggestions([]); return; }
        try {
          const normalized = text.toUpperCase().replace(/[^A-Z0-9\s]/g, '').trim();
          if (!normalized) { setSuggestions([]); return; }
          const url = `${SUPABASE_URL}/rest/v1/noleadnola_parcels?site_address=ilike.*${encodeURIComponent(normalized)}*&select=site_address&limit=6`;
          const resp = await fetch(url, { headers: SUPABASE_HEADERS });
          const rows = await resp.json();
          setSuggestions(rows.map(r => r.site_address));
          setShowDropdown(true);
        } catch { setSuggestions([]); }
      };

      const handleChange = (e) => {
        onChange(e.target.value);
        clearTimeout(debounceRef.current);
        debounceRef.current = setTimeout(() => fetchSuggestions(e.target.value), 300);
      };

      return (
        <div className="autocomplete-wrap">
          <input type="text" placeholder="e.g. 720 MARENGO ST" value={value}
            onChange={handleChange}
            onBlur={() => setTimeout(() => setShowDropdown(false), 200)}
            onFocus={() => { if (suggestions.length) setShowDropdown(true); }}
            autoComplete="off" />
          {showDropdown && suggestions.length > 0 && (
            <div className="autocomplete-list">
              {suggestions.map((s, i) => (
                <div key={i} className="autocomplete-item" onMouseDown={() => { onChange(s); setSuggestions([]); setShowDropdown(false); }}>
                  {s}
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }


    /* ═══════════════════════════════════════════════════════════
       MAP COMPONENT
       ═══════════════════════════════════════════════════════════ */
    function TicketMap({ tickets, selectedId, onSelectTicket, mapRef: externalMapRef }) {
      const mapRef = useRef(null);
      const mapInstanceRef = useRef(null);
      const markersRef = useRef({});

      useEffect(() => {
        if (!mapRef.current || mapInstanceRef.current) return;

        // Center on Orleans Parish
        const map = L.map(mapRef.current).setView([29.9511, -90.0715], 12);
        mapInstanceRef.current = map;
        if (externalMapRef) externalMapRef.current = map;

        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
          attribution: 'Esri',
          maxZoom: 20,
        }).addTo(map);

        return () => { map.remove(); mapInstanceRef.current = null; };
      }, []);

      // Update markers when tickets change
      useEffect(() => {
        const map = mapInstanceRef.current;
        if (!map) return;

        // Clear old markers
        Object.values(markersRef.current).forEach(m => map.removeLayer(m));
        markersRef.current = {};

        tickets.forEach(t => {
          if (!t.lat || !t.lng) return;

          const isSelected = t.id === selectedId;
          const statusColors = { resolved: '#2E7D32', closed: '#546E7A', 'in-progress': '#00235c', escalated: '#C62828', open: '#E65100' };
          const statusColor = statusColors[t.status] || '#E65100';

          const icon = L.divIcon({
            className: '',
            html: `<div style="
              background: ${isSelected ? '#C4392D' : statusColor};
              color: #fff;
              border-radius: 50%;
              width: ${isSelected ? '34px' : '28px'};
              height: ${isSelected ? '34px' : '28px'};
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: ${isSelected ? '0.75rem' : '0.65rem'};
              font-weight: 700;
              border: 2.5px solid #fff;
              box-shadow: 0 2px 8px rgba(0,0,0,0.35);
              font-family: 'Plus Jakarta Sans', sans-serif;
              transition: all 0.2s;
              ${isSelected ? 'transform: scale(1.1);' : ''}
            ">${t.id.split('-').pop()}</div>`,
            iconSize: [isSelected ? 34 : 28, isSelected ? 34 : 28],
            iconAnchor: [isSelected ? 17 : 14, isSelected ? 17 : 14],
          });

          const marker = L.marker([t.lat, t.lng], { icon }).addTo(map);
          marker.bindPopup(`
            <div class="marker-popup">
              <strong>${t.id}</strong>
              <div class="popup-addr">${t.address}</div>
              <div class="popup-status" style="color: ${statusColor}">${t.status.replace('-', ' ').toUpperCase()}</div>
            </div>
          `);
          marker.on('click', () => onSelectTicket(t.id));
          markersRef.current[t.id] = marker;
        });
      }, [tickets, selectedId]);

      // Pan to selected ticket
      useEffect(() => {
        const map = mapInstanceRef.current;
        if (!map || !selectedId) return;
        const ticket = tickets.find(t => t.id === selectedId);
        if (ticket && ticket.lat && ticket.lng) {
          map.flyTo([ticket.lat, ticket.lng], 16, { duration: 0.8 });
        }
      }, [selectedId]);

      return <div id="ticketMap" ref={mapRef}></div>;
    }


    /* ═══════════════════════════════════════════════════════════
       SYSTEM MESSAGE CARD
       ═══════════════════════════════════════════════════════════ */
    const AITagSmall = () => <span className="ai-tag"><IconAI /> AI Generated</span>;
    const AITagBody = () => <div className="ai-tag-body"><IconAI /> AI Generated Message</div>;

    function SystemCard({ msg }) {
      const icons = {
        check: <IconCheck />,
        ai: <IconAI />,
        forward: <IconForward />,
        connected: <IconConnect />,
      };
      const isAI = msg.aiGenerated || msg.variant === 'ai' || (msg.variant === 'forwarded' && (msg.aiSummary || msg.photo));
      return (
        <div className="msg system" style={{ animationDelay: '0.1s' }}>
          <div className="system-card">
            <div className={`system-card-header ${msg.variant}`}>
              {icons[msg.icon]}
              <span>{msg.title}</span>
              {isAI && <AITagSmall />}
              <span style={{ flex: 1 }}></span>
              <span className="msg-time">{msg.time}</span>
            </div>
            <div className="system-card-body">
              {isAI && msg.variant !== 'ai' && <AITagBody />}
              {msg.variant === 'forwarded' && msg.photo ? (
                <>
                  <img src={msg.photo} alt="Attached" className="forwarded-photo" />
                  <div style={{ fontSize: '0.85rem', lineHeight: 1.6 }}>{msg.text}</div>
                </>
              ) : msg.variant === 'ai' && msg.photo ? (
                <div className="ai-summary">
                  <img src={msg.photo} alt="Analysis" className="ai-summary-thumb" />
                  <div className="ai-summary-text">
                    <strong>Image Analysis</strong>
                    {msg.text}
                  </div>
                </div>
              ) : msg.variant === 'forwarded' && msg.aiSummary ? (
                <div style={{ fontSize: '0.85rem', lineHeight: 1.6 }}>{msg.text}</div>
              ) : msg.text}
            </div>
          </div>
        </div>
      );
    }


    /* ═══════════════════════════════════════════════════════════
       CHAT VIEW (Ticket Detail)
       ═══════════════════════════════════════════════════════════ */
    function ChatView({ ticket, onBack, onClose, onEscalate }) {
      const messagesEndRef = useRef(null);
      const [inputMsg, setInputMsg] = useState('');

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [ticket]);

      const formatDate = (d) => {
        const dt = new Date(d);
        return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      };

      const getInitials = (name) => name.split(' ').map(w => w[0]).join('').toUpperCase();

      const isClosed = ticket.status === 'closed' || ticket.status === 'resolved';
      const isEscalated = ticket.status === 'escalated';

      return (
        <div className="chat-view">
          <div className="chat-header">
            <div className="chat-header-top">
              <button className="chat-back-btn" onClick={onBack}><IconBack /></button>
              <div className="chat-header-info">
                <div className="chat-header-case">{ticket.id}</div>
                <div className="chat-header-addr">{ticket.address}</div>
              </div>
              <span className={`ticket-status-badge ${ticket.status}`}>
                {ticket.status.replace('-', ' ')}
              </span>
            </div>
            <div className="chat-header-meta">
              <span className="chat-meta-item"><IconUser /> {ticket.customer}</span>
              <span className="chat-meta-item"><IconClock /> {formatDate(ticket.date)}</span>
              {ticket.urgency && <span className={`urgency-badge ${ticket.urgency}`}>{ticket.urgency}</span>}
              {ticket.assignedTo && (
                <span className="assigned-badge">
                  <span className="assigned-avatar">{getInitials(ticket.assignedTo)}</span>
                  {ticket.assignedTo}
                </span>
              )}
            </div>
          </div>

          <div className="case-actions">
            {isClosed ? (
              <span className="case-action-btn closed-badge"><IconClose /> Case Closed</span>
            ) : (
              <>
                <button className="case-action-btn close-case" onClick={() => onClose(ticket.id)}>
                  <IconClose /> Close Case
                </button>
                {isEscalated ? (
                  <span className="case-action-btn" style={{ borderColor: '#C62828', color: '#C62828', background: '#FCE4EC', cursor: 'default' }}>
                    <IconEscalate /> Escalated
                  </span>
                ) : (
                  <button className="case-action-btn escalate-case" onClick={() => onEscalate(ticket.id)}>
                    <IconEscalate /> Escalate Case
                  </button>
                )}
              </>
            )}
          </div>

          <div className="chat-messages">
            {ticket.messages.map((msg, i) => {
              if (msg.type === 'system') return <SystemCard key={i} msg={msg} />;

              const isCustomer = msg.type === 'customer';
              const initials = getInitials(msg.sender);

              return (
                <div key={i} className={`msg ${msg.type}`} style={{ animationDelay: `${i * 0.05}s` }}>
                  <div className="msg-avatar">{initials}</div>
                  <div className="msg-body">
                    <div className="msg-sender">
                      {msg.sender}
                      <span className="msg-time">{msg.time}</span>
                    </div>
                    <div className="msg-bubble">
                      {msg.text}
                      {msg.photo && (
                        <img src={msg.photo} alt="Uploaded photo" className="msg-photo" />
                      )}
                    </div>
                  </div>
                </div>
              );
            })}
            <div ref={messagesEndRef} />
          </div>

          <div className="chat-input-bar">
            <textarea
              placeholder="Type a message..."
              value={inputMsg}
              onChange={e => setInputMsg(e.target.value)}
              rows={1}
            />
            <button className="chat-send-btn"><IconSend /></button>
          </div>
        </div>
      );
    }


    /* ═══════════════════════════════════════════════════════════
       NEW TICKET FORM
       ═══════════════════════════════════════════════════════════ */
    function NewTicketForm({ onCancel, onSubmit }) {
      const [address, setAddress] = useState('');
      const [customer, setCustomer] = useState('');
      const [message, setMessage] = useState('');
      const now = new Date();
      const dateStr = now.toLocaleString('en-US', {
        weekday: 'short', month: 'short', day: 'numeric', year: 'numeric',
        hour: 'numeric', minute: '2-digit', hour12: true
      });

      const handleSubmit = () => {
        if (!address.trim() || !customer.trim() || !message.trim()) return;
        onSubmit({ address: address.trim(), customer: customer.trim(), message: message.trim(), date: now.toISOString() });
      };

      return (
        <div className="form-view">
          <div className="panel-header">
            <button className="chat-back-btn" onClick={onCancel}><IconBack /></button>
            <h2>New Complaint</h2>
          </div>
          <div className="form-scroll">
            <div className="form-field">
              <label>Address</label>
              <TicketAddressInput value={address} onChange={setAddress} />
            </div>
            <div className="form-field">
              <label>Customer Name</label>
              <input type="text" placeholder="Full name" value={customer} onChange={e => setCustomer(e.target.value)} />
            </div>
            <div className="form-field">
              <label>Message</label>
              <textarea placeholder="Describe the complaint in detail..." value={message} onChange={e => setMessage(e.target.value)} />
            </div>
            <div className="form-field">
              <label>Photo</label>
              <div className="photo-upload-area">
                <IconCamera />
                <p>Click to upload photos</p>
                <div className="hint">JPG, PNG, HEIC up to 10MB</div>
              </div>
            </div>
            <div className="form-field">
              <label>Date & Time</label>
              <div className="datetime-display">
                <IconClock />
                {dateStr}
              </div>
            </div>
          </div>
          <div className="form-actions">
            <button className="btn-cancel" onClick={onCancel}>Cancel</button>
            <button className="btn-submit" onClick={handleSubmit} disabled={!address.trim() || !customer.trim() || !message.trim()}>
              Create Complaint
            </button>
          </div>
        </div>
      );
    }


    /* ═══════════════════════════════════════════════════════════
       TICKET LIST
       ═══════════════════════════════════════════════════════════ */
    function TicketList({ tickets, selectedId, onSelect, onNewTicket, filters, onFilterChange }) {
      const formatDate = (d) => {
        const dt = new Date(d);
        return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' at ' +
          dt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      };

      // Get unique contractors from tickets
      const contractors = [...new Set(tickets.map(t => t.assignedTo).filter(Boolean))];

      // Check if any filter is active
      const hasFilters = filters.status || filters.urgency || filters.contractor || filters.dateRange;

      // Apply filters
      let filtered = tickets;
      if (filters.status) filtered = filtered.filter(t => t.status === filters.status);
      if (filters.urgency) filtered = filtered.filter(t => t.urgency === filters.urgency);
      if (filters.contractor) filtered = filtered.filter(t => t.assignedTo === filters.contractor);
      if (filters.dateRange) {
        const now = new Date();
        filtered = filtered.filter(t => {
          const d = new Date(t.date);
          if (filters.dateRange === 'today') return d.toDateString() === now.toDateString();
          if (filters.dateRange === '3days') return (now - d) <= 3 * 86400000;
          if (filters.dateRange === 'week') return (now - d) <= 7 * 86400000;
          return true;
        });
      }

      return (
        <>
          <div className="panel-header">
            <h2>Complaints</h2>
            <span className="ticket-count">{filtered.length} of {tickets.length}</span>
            <button className="btn-new-ticket" onClick={onNewTicket}><IconPlus /> New</button>
          </div>
          <div className="filter-bar">
            <select className={`filter-select ${filters.status ? 'active-filter' : ''}`}
              value={filters.status} onChange={e => onFilterChange('status', e.target.value)}>
              <option value="">All Statuses</option>
              <option value="open">Open</option>
              <option value="in-progress">In Progress</option>
              <option value="escalated">Escalated</option>
              <option value="resolved">Resolved</option>
              <option value="closed">Closed</option>
            </select>
            <select className={`filter-select ${filters.urgency ? 'active-filter' : ''}`}
              value={filters.urgency} onChange={e => onFilterChange('urgency', e.target.value)}>
              <option value="">All Urgency</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
            <select className={`filter-select ${filters.contractor ? 'active-filter' : ''}`}
              value={filters.contractor} onChange={e => onFilterChange('contractor', e.target.value)}>
              <option value="">All Contractors</option>
              {contractors.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
            <select className={`filter-select ${filters.dateRange ? 'active-filter' : ''}`}
              value={filters.dateRange} onChange={e => onFilterChange('dateRange', e.target.value)}>
              <option value="">All Dates</option>
              <option value="today">Today</option>
              <option value="3days">Last 3 Days</option>
              <option value="week">Last 7 Days</option>
            </select>
            <button className={`filter-clear ${hasFilters ? 'visible' : ''}`}
              onClick={() => onFilterChange('clear')}>
              Clear
            </button>
          </div>
          <div className="ticket-list">
            {filtered.length === 0 && (
              <div style={{ padding: '32px 20px', textAlign: 'center', color: 'var(--text-light)', fontSize: '0.88rem' }}>
                No complaints match the selected filters.
              </div>
            )}
            {filtered.map(t => (
              <div key={t.id} className={`ticket-item ${t.id === selectedId ? 'active' : ''}`} onClick={() => onSelect(t.id)}>
                <div className={`status-dot ${t.status}`}></div>
                <div className="ticket-info">
                  <div className="ticket-case">{t.id}</div>
                  <div className="ticket-addr">{t.address}</div>
                  <div className="ticket-preview">{t.customer} — {t.message}</div>
                  <div className="ticket-meta">
                    <span className="ticket-date">{formatDate(t.date)}</span>
                    <span className={`ticket-status-badge ${t.status}`}>{t.status.replace('-', ' ')}</span>
                    {t.urgency && <span className={`urgency-badge ${t.urgency}`}>{t.urgency}</span>}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </>
      );
    }


    /* ═══════════════════════════════════════════════════════════
       APP (root)
       ═══════════════════════════════════════════════════════════ */
    /* ═══════════════════════════════════════════════════════════
       RESIZE HANDLE
       ═══════════════════════════════════════════════════════════ */
    function ResizeHandle({ onResize }) {
      const [dragging, setDragging] = useState(false);

      const handleMouseDown = useCallback((e) => {
        e.preventDefault();
        setDragging(true);

        const onMouseMove = (e) => {
          onResize(e.clientX);
        };

        const onMouseUp = () => {
          setDragging(false);
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        };

        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      }, [onResize]);

      return <div className={`resize-handle ${dragging ? 'dragging' : ''}`} onMouseDown={handleMouseDown} />;
    }


    function App() {
      const [tickets, setTickets] = useState(MOCK_TICKETS);
      const [selectedId, setSelectedId] = useState('CMP-2026-0041');
      const [view, setView] = useState('detail');  // 'list' | 'detail' | 'new'
      const [filters, setFilters] = useState({ status: '', urgency: '', contractor: '', dateRange: '' });
      const [panelWidth, setPanelWidth] = useState(50); // percentage
      const layoutRef = useRef(null);
      const mapRef = useRef(null);

      const handleResize = useCallback((clientX) => {
        const layout = layoutRef.current;
        if (!layout) return;
        const rect = layout.getBoundingClientRect();
        const totalWidth = rect.width;
        const panelPx = rect.right - clientX;
        const pct = Math.round((panelPx / totalWidth) * 100);
        // Clamp between 10% (min panel) and 90% (max panel)
        setPanelWidth(Math.max(10, Math.min(90, pct)));
      }, []);

      // Invalidate Leaflet map size after resize so tiles fill correctly
      useEffect(() => {
        const timer = setTimeout(() => {
          if (mapRef.current) mapRef.current.invalidateSize();
        }, 50);
        return () => clearTimeout(timer);
      }, [panelWidth]);

      const handleFilterChange = useCallback((key, value) => {
        if (key === 'clear') {
          setFilters({ status: '', urgency: '', contractor: '', dateRange: '' });
        } else {
          setFilters(prev => ({ ...prev, [key]: value }));
        }
      }, []);

      const handleSelectTicket = useCallback((id) => {
        setSelectedId(id);
        setView('detail');
      }, []);

      const handleCloseTicket = useCallback((id) => {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        setTickets(prev => prev.map(t => t.id === id ? {
          ...t,
          status: 'closed',
          messages: [...t.messages, {
            type: 'system',
            variant: 'connected',
            title: 'Case Closed',
            icon: 'check',
            text: 'This case has been reviewed and closed by the administrator.',
            time: timeStr,
          }],
        } : t));
      }, []);

      const handleEscalateTicket = useCallback((id) => {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        setTickets(prev => prev.map(t => t.id === id ? {
          ...t,
          status: 'escalated',
          urgency: 'high',
          messages: [...t.messages, {
            type: 'system',
            variant: 'forwarded',
            title: 'Case Escalated',
            icon: 'forward',
            text: 'This case has been escalated to a supervisor for priority review and resolution.',
            time: timeStr,
          }],
        } : t));
      }, []);

      const handleNewTicket = useCallback((data) => {
        const num = String(tickets.length + 30).padStart(4, '0');
        const newTicket = {
          id: `CMP-2026-${num}`,
          address: data.address,
          customer: data.customer,
          message: data.message,
          photo: null,
          date: data.date,
          status: 'open',
          urgency: 'medium',
          lat: 29.95 + (Math.random() - 0.5) * 0.06,
          lng: -90.07 + (Math.random() - 0.5) * 0.06,
          assignedTo: null,
          assignedRole: null,
          messages: [
            {
              type: 'customer',
              sender: data.customer,
              text: data.message,
              time: new Date(data.date).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
            },
            {
              type: 'system',
              variant: 'info',
              title: 'Complaint Received',
              icon: 'check',
              text: 'We have received your complaint. A team member will review it shortly.',
              time: new Date(data.date).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }),
            },
          ],
        };
        setTickets(prev => [newTicket, ...prev]);
        setSelectedId(newTicket.id);
        setView('detail');
      }, [tickets]);

      const selectedTicket = tickets.find(t => t.id === selectedId);

      return (
        <div className="app-shell">
          <div className="top-bar">
            <img src="Logos/SWBNO_logo.svg" alt="SWBNO" className="nav-logo" />
            <div className="brand">Orleans Parish Community</div>
            <div className="nav-spacer"></div>
            <nav className="nav-links">
              <a href="index.html" className="nav-link">Home</a>
              <a href="index.html#questionnaire" className="nav-link">Questionnaire</a>
              <a href="ticketing.html" className="nav-link active">Complaints</a>
            </nav>
          </div>

          <div className="main-layout" ref={layoutRef}>
            <div className="map-container">
              <TicketMap tickets={tickets} selectedId={selectedId} onSelectTicket={handleSelectTicket} mapRef={mapRef} />
            </div>

            <ResizeHandle onResize={handleResize} />

            <div className="side-panel" style={{ width: panelWidth + '%' }}>
              {view === 'new' ? (
                <NewTicketForm
                  onCancel={() => setView(selectedId ? 'detail' : 'list')}
                  onSubmit={handleNewTicket}
                />
              ) : view === 'detail' && selectedTicket ? (
                <ChatView
                  ticket={selectedTicket}
                  onBack={() => setView('list')}
                  onClose={handleCloseTicket}
                  onEscalate={handleEscalateTicket}
                />
              ) : (
                <TicketList
                  tickets={tickets}
                  selectedId={selectedId}
                  onSelect={handleSelectTicket}
                  onNewTicket={() => setView('new')}
                  filters={filters}
                  onFilterChange={handleFilterChange}
                />
              )}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>

</html>
